<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Location Analysis Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Leaflet CSS for map display -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet.heat plugin for heatmaps -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 30px;
            padding-bottom: 50px;
        }
        .map-container {
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        /* Make sure the map fills the container */
        .map-container iframe,
        .map-container .folium-map {
            width: 100% !important;
            height: 100% !important;
            border: none;
            display: block !important;
        }
        /* Force the OpenStreetMap attribution to be visible */
        .leaflet-control-attribution {
            background-color: rgba(255, 255, 255, 0.8) !important;
            padding: 3px 8px !important;
            border-radius: 3px !important;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1) !important;
        }
        /* Force Leaflet marker icons to show properly */
        .leaflet-marker-icon {
            visibility: visible !important;
            opacity: 1 !important;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 30px;
        }
        .card-header {
            background-color: #4285f4;
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        .btn-primary {
            background-color: #4285f4;
            border-color: #4285f4;
        }
        .btn-primary:hover {
            background-color: #3367d6;
            border-color: #3367d6;
        }
        .analysis-section {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
        }
        .heatmap {
            background: linear-gradient(to right, #00FFFF, #0000FF);
        }
        .existing-hospital {
            background-color: blue;
        }
        .new-hospital {
            background-color: green;
        }
        .population-point {
            background-color: red;
            opacity: 0.7;
        }
        .interactive-tip {
            background-color: #fffacd;
            border-left: 4px solid #ffd700;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .feature-highlight {
            font-weight: bold;
            color: #d35400;
        }
        .map-controls-help {
            background-color: #e8f4fd;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
        }
        /* Add troubleshooting section styling */
        .troubleshooting {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #6c757d;
        }
        .hospital-icon {
            color: blue;
            font-size: 16px;
            margin-right: 5px;
        }
        .new-hospital-icon {
            color: green;
            font-size: 16px;
            margin-right: 5px;
        }
        .results-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        .data-source-badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .badge-default {
            background-color: #e0e0e0;
            color: #333;
        }
        .badge-custom {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        /* Heat map control styles */
        .heatmap-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-top: 1px solid #e0e0e0;
        }
        .value-display {
            display: inline-block;
            width: 40px;
            text-align: right;
            font-weight: bold;
        }
        .slider-container {
            display: flex;
            align-items: center;
        }
        .color-preview {
            height: 20px;
            margin-top: 5px;
            border-radius: 3px;
            background: linear-gradient(to right, blue, lime, yellow, red);
        }
        .color-stop {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 5px;
            cursor: pointer;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="results-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Hospital Location Analysis Results</h1>
                <a href="/" class="btn btn-outline-primary">New Analysis</a>
            </div>

            {% if data_source %}
            <div>
                <span class="data-source-badge {% if data_source == 'custom' %}badge-custom{% else %}badge-default{% endif %}">
                    {% if data_source == 'custom' %}
                        Custom Data
                    {% else %}
                        {{ dataset_name }}
                    {% endif %}
                </span>
            </div>
            {% endif %}

            <!-- Nav tabs -->
            <ul class="nav nav-pills mb-4" id="mapTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="combined-map-tab" data-bs-toggle="tab" data-bs-target="#combined-map" type="button" role="tab" aria-controls="combined-map" aria-selected="true">Interactive Map</button>
                </li>
                {% if service_coverage_map_html %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="service-coverage-tab" data-bs-toggle="tab" data-bs-target="#service-coverage-map" type="button" role="tab" aria-controls="service-coverage-map" aria-selected="false">Service Coverage</button>
                </li>
                {% endif %}
            </ul>

            <!-- Tab content -->
            <div class="tab-content">
                <div class="tab-pane fade show active" id="combined-map" role="tabpanel" aria-labelledby="combined-map-tab">
                    <div class="map-container">
                        <div id="direct-map" style="width: 100%; height: 100%;"></div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <strong>Interactive Map with Layers:</strong> Use the layer control in the top-right corner to toggle different views.
                        <div class="mt-2">
                            <strong>Hospital Analysis:</strong> Click anywhere on the map to analyze potential for a new hospital at that location.
                            <div class="form-check form-switch d-inline-block ms-3">
                                <input class="form-check-input" type="checkbox" id="enableDirectMapClick" checked>
                                <label class="form-check-label" for="enableDirectMapClick">Enable click analysis</label>
                            </div>
                            <div class="d-inline-block ms-3">
                                <label for="directAnalysisRadius" class="form-label d-inline">Radius: <span id="directRadiusValue">1</span> km</label>
                                <input type="range" class="form-range d-inline-block mx-2" style="width: 150px;" min="0.5" max="5" step="0.5" value="1" id="directAnalysisRadius">
                            </div>
                        </div>

                        <!-- Heat Map Controls -->
                        <div id="heatmapControls" class="mt-3 p-3 border rounded">
                            <h6><i class="fas fa-fire me-2"></i>Population Heat Map Settings</h6>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <label for="heatmapRadius" class="form-label">Heat Radius: <span id="heatRadiusValue" class="value-display">25</span>px</label>
                                    <div class="slider-container">
                                        <input type="range" class="form-range" min="5" max="100" step="1" value="25" id="heatmapRadius" style="width: 85%;">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="heatmapIntensity" class="form-label">Intensity: <span id="heatIntensityValue" class="value-display">0.6</span></label>
                                    <div class="slider-container">
                                        <input type="range" class="form-range" min="0.1" max="2.0" step="0.05" value="0.6" id="heatmapIntensity" style="width: 85%;">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="heatmapBlur" class="form-label">Blur: <span id="heatBlurValue" class="value-display">15</span>px</label>
                                    <div class="slider-container">
                                        <input type="range" class="form-range" min="5" max="50" step="1" value="15" id="heatmapBlur" style="width: 85%;">
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <label class="form-label">Color Gradient</label>
                                    <div class="color-preview" id="gradientPreview"></div>
                                    <div class="row mt-2">
                                        <div class="col-md-3">
                                            <div class="color-stop">
                                                <div class="color-swatch" id="colorStop1" style="background-color: blue;"></div>
                                                <label>Start <input type="number" class="form-control form-control-sm" id="colorStop1Value" min="0.1" max="0.4" step="0.05" value="0.2" style="width: 70px;"></label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="color-stop">
                                                <div class="color-swatch" id="colorStop2" style="background-color: cyan;"></div>
                                                <label>2nd <input type="number" class="form-control form-control-sm" id="colorStop2Value" min="0.3" max="0.6" step="0.05" value="0.4" style="width: 70px;"></label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="color-stop">
                                                <div class="color-swatch" id="colorStop3" style="background-color: lime;"></div>
                                                <label>3rd <input type="number" class="form-control form-control-sm" id="colorStop3Value" min="0.5" max="0.8" step="0.05" value="0.6" style="width: 70px;"></label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="color-stop">
                                                <div class="color-swatch" id="colorStop4" style="background-color: red;"></div>
                                                <label>End <input type="number" class="form-control form-control-sm" id="colorStop4Value" min="0.7" max="1.0" step="0.05" value="0.8" style="width: 70px;"></label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label for="heatmapColorScheme" class="form-label">Preset Color Schemes</label>
                                    <select class="form-select" id="heatmapColorScheme">
                                        <option value="default">Default (Blue-Green-Yellow-Red)</option>
                                        <option value="bluered">Blue to Red</option>
                                        <option value="purplegreen">Purple to Green</option>
                                        <option value="monochrome">Monochrome (Blue)</option>
                                        <option value="thermal">Thermal (Black-Red-Yellow-White)</option>
                                        <option value="rainbow">Rainbow</option>
                                        <option value="custom">Custom (Use color pickers)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 text-end">
                                    <label class="form-label">&nbsp;</label><br>
                                    <button id="applyHeatmapSettings" class="btn btn-primary">Apply Settings</button>
                                    <button id="resetHeatmapSettings" class="btn btn-outline-secondary ms-2">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if service_coverage_map_html %}
                <div class="tab-pane fade" id="service-coverage-map" role="tabpanel" aria-labelledby="service-coverage-tab">
                    <div class="map-container">
                        {{ service_coverage_map_html|safe }}
                    </div>
                    <div class="alert alert-info">
                        <strong>Service Coverage Map:</strong> Shows hospital service areas, underserved regions, and coverage projections for recommended locations.
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="analysis-container mt-4">
                <h2>AI Analysis</h2>
                <div>
                    {{ analysis|safe }}
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="/" class="btn btn-primary">Return to Homepage</a>
            </div>
        </div>
    </div>

    <!-- Add Leaflet JS for map functionality -->
    <!-- <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Add location analysis UI elements -->
    <div class="modal fade" id="locationAnalysisModal" tabindex="-1" aria-labelledby="locationAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="locationAnalysisModalLabel">Hospital Location Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="analysisLoading" class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing location...</p>
                    </div>
                    <div id="analysisResults" style="display: none;">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="card-title mb-0">AI Recommendation</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center mb-3">
                                            <div class="position-relative" style="width: 150px; height: 150px; margin: 0 auto;">
                                                <div class="position-absolute top-50 start-50 translate-middle">
                                                    <h1 id="recommendationPercentage" style="font-size: 3rem; font-weight: bold;"></h1>
                                                </div>
                                                <svg width="150" height="150" viewBox="0 0 150 150">
                                                    <circle cx="75" cy="75" r="60" fill="none" stroke="#e0e0e0" stroke-width="15"/>
                                                    <circle id="recommendationGauge" cx="75" cy="75" r="60" fill="none" stroke="#4285F4" stroke-width="15" stroke-dasharray="376.8" stroke-dashoffset="376.8" transform="rotate(-90 75 75)"/>
                                                </svg>
                                            </div>
                                        </div>
                                        <p id="recommendationExplanation" class="mt-3"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="card-title mb-0">Statistics</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                Location
                                                <span id="locationCoordinates" class="badge bg-primary rounded-pill"></span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                Analysis Radius
                                                <span id="analysisRadius" class="badge bg-primary rounded-pill"></span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                Population
                                                <span id="populationCount" class="badge bg-primary rounded-pill"></span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                Existing Hospitals
                                                <span id="hospitalCount" class="badge bg-primary rounded-pill"></span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="locationMapContainer" class="map-container" style="height: 400px;"></div>
                    </div>
                    <div id="analysisError" class="alert alert-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript to ensure map layers visibility and proper initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tabs
            var mapTabs = document.getElementById('mapTabs');
            var tabs = new bootstrap.Tab(mapTabs);

            // Initialize the modal
            analysisModal = new bootstrap.Modal(document.getElementById('locationAnalysisModal'));

            // Create map and layers
            initializeDirectMap();
        });

        // Global variables
        let directMap = null;
        let markerGroup = null;
        let heatmapLayer = null;
        let hospitalsLayer = null;
        let analysisCircle = null;
        let analysisModal = null;
        let selectedMarker = null;

        function initializeDirectMap() {
            try {
                // Get map data directly from the server
                const mapCenter = {{ map_center|safe }} || [-33.8688, 151.2093]; // Default Sydney coordinates
                const mapZoom = {{ map_zoom|default(11) }};
                const hospitalData = {{ hospital_data|tojson|safe }} || [];
                const populationData = {{ population_data|tojson|safe }} || [];

                // Create map centered on provided coordinates
                directMap = L.map('direct-map').setView([mapCenter[0], mapCenter[1]], mapZoom);

                // Add base tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(directMap);

                // Create layer groups
                markerGroup = L.layerGroup().addTo(directMap);

                // Add hospital markers to the map
                hospitalsLayer = L.layerGroup();

                // Add markers for all hospitals
                hospitalData.forEach(hospital => {
                    if (hospital.latitude && hospital.longitude) {
                        const marker = L.marker([hospital.latitude, hospital.longitude], {
                            icon: L.divIcon({
                                html: '<i class="fa fa-hospital" style="color: #EA4335; font-size: 18px;"></i>',
                                className: 'hospital-marker',
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            })
                        });

                        const hospitalName = hospital.hospitalname || hospital.name || 'Hospital';
                        const hospitalType = hospital.type || 'Unknown';
                        marker.bindPopup(`<strong>${hospitalName}</strong><br>Type: ${hospitalType}`);
                        hospitalsLayer.addLayer(marker);
                    }
                });
                hospitalsLayer.addTo(directMap);

                // Create heatmap from population data
                const heatmapPoints = [];
                populationData.forEach(area => {
                    if (area.latitude && area.longitude && area.population) {
                        // Add weight based on population
                        heatmapPoints.push([
                            area.latitude,
                            area.longitude,
                            Math.min(1.0, area.population / 10000) // Normalize population for heat intensity
                        ]);
                    }
                });

                if (heatmapPoints.length > 0) {
                    heatmapLayer = L.heatLayer(heatmapPoints, {
                        radius: 25,
                        blur: 15,
                        maxZoom: 17,
                        gradient: {0.4: 'blue', 0.65: 'lime', 0.85: 'yellow', 1: 'red'}
                    });
                    heatmapLayer.addTo(directMap);
                } else {
                    console.warn("No heatmap points available");
                }

                // Set up heat map controls event listeners
                setupHeatmapControls(heatmapPoints);

                // Set up click handler
                setupDirectMapClickHandler();

                // Add layer controls
                const baseLayers = {
                    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    })
                };

                const overlayLayers = {
                    "Existing Hospitals": hospitalsLayer
                };

                if (heatmapLayer) {
                    overlayLayers["Population Density"] = heatmapLayer;
                }

                L.control.layers(baseLayers, overlayLayers).addTo(directMap);

                // Update radius event handler
                const radiusSlider = document.getElementById('directAnalysisRadius');
                const radiusValue = document.getElementById('directRadiusValue');

                radiusSlider.addEventListener('input', function() {
                    radiusValue.textContent = this.value;

                    // Update circle radius if it exists
                    if (analysisCircle) {
                        analysisCircle.setRadius(parseFloat(this.value) * 1000);
                    }
                });

                console.log("Direct map initialized successfully");
            } catch (e) {
                console.error("Error initializing direct map:", e);
                document.getElementById('direct-map').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading map:</strong> ${e.message}<br>
                        Please try refreshing the page. If the issue persists, you can use the
                        <a href="/test_hospital_location" target="_blank">dedicated analysis page</a>.
                    </div>
                `;
            }
        }

        function setupHeatmapControls(heatmapPoints) {
            if (!heatmapPoints || heatmapPoints.length === 0) {
                // Hide controls if no heat map data
                document.getElementById('heatmapControls').style.display = 'none';
                return;
            }

            // Get control elements
            const radiusSlider = document.getElementById('heatmapRadius');
            const radiusValue = document.getElementById('heatRadiusValue');
            const intensitySlider = document.getElementById('heatmapIntensity');
            const intensityValue = document.getElementById('heatIntensityValue');
            const blurSlider = document.getElementById('heatmapBlur');
            const blurValue = document.getElementById('heatBlurValue');
            const colorSchemeSelect = document.getElementById('heatmapColorScheme');
            const applyButton = document.getElementById('applyHeatmapSettings');
            const resetButton = document.getElementById('resetHeatmapSettings');
            const gradientPreview = document.getElementById('gradientPreview');

            // Color stop elements
            const colorStop1 = document.getElementById('colorStop1');
            const colorStop2 = document.getElementById('colorStop2');
            const colorStop3 = document.getElementById('colorStop3');
            const colorStop4 = document.getElementById('colorStop4');
            const colorStop1Value = document.getElementById('colorStop1Value');
            const colorStop2Value = document.getElementById('colorStop2Value');
            const colorStop3Value = document.getElementById('colorStop3Value');
            const colorStop4Value = document.getElementById('colorStop4Value');

            // Default colors
            let colors = {
                stop1: { color: 'blue', position: 0.2 },
                stop2: { color: 'cyan', position: 0.4 },
                stop3: { color: 'lime', position: 0.6 },
                stop4: { color: 'red', position: 0.8 }
            };

            // Update display values when sliders change without causing layout shifts
            radiusSlider.addEventListener('input', function() {
                radiusValue.textContent = this.value;
            });

            intensitySlider.addEventListener('input', function() {
                intensityValue.textContent = this.value;
            });

            blurSlider.addEventListener('input', function() {
                blurValue.textContent = this.value;
            });

            // Update color swatch when clicking on it
            function setupColorSwatch(swatch) {
                swatch.addEventListener('click', function() {
                    // Create a color input
                    const colorInput = document.createElement('input');
                    colorInput.type = 'color';
                    colorInput.value = rgbToHex(this.style.backgroundColor);
                    colorInput.style.opacity = 0;
                    colorInput.style.position = 'absolute';

                    // Append to DOM
                    document.body.appendChild(colorInput);

                    // Trigger click and listen for changes
                    colorInput.click();
                    colorInput.addEventListener('input', function() {
                        swatch.style.backgroundColor = this.value;
                        updateGradientPreview();
                    });

                    colorInput.addEventListener('change', function() {
                        document.body.removeChild(colorInput);
                    });
                });
            }

            // Setup color swatch click handlers
            setupColorSwatch(colorStop1);
            setupColorSwatch(colorStop2);
            setupColorSwatch(colorStop3);
            setupColorSwatch(colorStop4);

            // Helper to convert RGB to hex
            function rgbToHex(rgb) {
                // Default to black if undefined
                if (!rgb) return '#000000';

                // Handle different formats
                if (rgb.startsWith('#')) return rgb;

                // Extract r, g, b components
                const match = rgb.match(/^rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i);
                if (match) {
                    return '#' +
                        ('0' + parseInt(match[1], 10).toString(16)).slice(-2) +
                        ('0' + parseInt(match[2], 10).toString(16)).slice(-2) +
                        ('0' + parseInt(match[3], 10).toString(16)).slice(-2);
                }
                return '#000000';
            }

            // Update gradient preview
            function updateGradientPreview() {
                const stop1 = colorStop1.style.backgroundColor || 'blue';
                const stop2 = colorStop2.style.backgroundColor || 'cyan';
                const stop3 = colorStop3.style.backgroundColor || 'lime';
                const stop4 = colorStop4.style.backgroundColor || 'red';

                const pos1 = parseFloat(colorStop1Value.value) * 100 + '%';
                const pos2 = parseFloat(colorStop2Value.value) * 100 + '%';
                const pos3 = parseFloat(colorStop3Value.value) * 100 + '%';
                const pos4 = parseFloat(colorStop4Value.value) * 100 + '%';

                gradientPreview.style.background = `linear-gradient(to right,
                    ${stop1} ${pos1},
                    ${stop2} ${pos2},
                    ${stop3} ${pos3},
                    ${stop4} ${pos4})`;
            }

            // Update preview when stop positions change
            colorStop1Value.addEventListener('input', updateGradientPreview);
            colorStop2Value.addEventListener('input', updateGradientPreview);
            colorStop3Value.addEventListener('input', updateGradientPreview);
            colorStop4Value.addEventListener('input', updateGradientPreview);

            // When color scheme changes
            colorSchemeSelect.addEventListener('change', function() {
                const scheme = this.value;

                // Update color swatches and values based on preset
                switch(scheme) {
                    case 'default': // Default blue-green-yellow-red
                        setColorScheme('blue', 'cyan', 'lime', 'red', 0.2, 0.4, 0.6, 0.8);
                        break;
                    case 'bluered': // Blue to Red
                        setColorScheme('#0000FF', '#9900FF', '#FF0099', '#FF0000', 0.2, 0.4, 0.6, 0.8);
                        break;
                    case 'purplegreen': // Purple to Green
                        setColorScheme('#9900FF', '#6600CC', '#33CC33', '#00FF00', 0.2, 0.4, 0.6, 0.8);
                        break;
                    case 'monochrome': // Monochrome Blue
                        setColorScheme('#CCCCFF', '#9999FF', '#6666FF', '#0000FF', 0.2, 0.4, 0.6, 0.8);
                        break;
                    case 'thermal': // Thermal
                        setColorScheme('#000000', '#990000', '#FF6600', '#FFFF00', 0.1, 0.3, 0.6, 0.9);
                        break;
                    case 'rainbow': // Rainbow
                        setColorScheme('#0000FF', '#00FFFF', '#00FF00', '#FF0000', 0.1, 0.3, 0.5, 0.9);
                        break;
                    case 'custom': // Custom - keep current values
                        break;
                }

                // If not custom, update the preview
                if (scheme !== 'custom') {
                    updateGradientPreview();
                }
            });

            // Helper to set color scheme
            function setColorScheme(c1, c2, c3, c4, p1, p2, p3, p4) {
                colorStop1.style.backgroundColor = c1;
                colorStop2.style.backgroundColor = c2;
                colorStop3.style.backgroundColor = c3;
                colorStop4.style.backgroundColor = c4;

                colorStop1Value.value = p1;
                colorStop2Value.value = p2;
                colorStop3Value.value = p3;
                colorStop4Value.value = p4;
            }

            // Initialize gradient preview
            updateGradientPreview();

            // Apply button click handler
            applyButton.addEventListener('click', function() {
                // Get current settings
                const radius = parseInt(radiusSlider.value);
                const intensity = parseFloat(intensitySlider.value);
                const blur = parseInt(blurSlider.value);

                // Get current color stops
                const gradient = {};
                gradient[parseFloat(colorStop1Value.value)] = colorStop1.style.backgroundColor || 'blue';
                gradient[parseFloat(colorStop2Value.value)] = colorStop2.style.backgroundColor || 'cyan';
                gradient[parseFloat(colorStop3Value.value)] = colorStop3.style.backgroundColor || 'lime';
                gradient[parseFloat(colorStop4Value.value)] = colorStop4.style.backgroundColor || 'red';

                // Remove existing heatmap layer
                if (heatmapLayer) {
                    directMap.removeLayer(heatmapLayer);
                }

                // Scale original points based on intensity setting
                const scaledPoints = heatmapPoints.map(point => {
                    // Point format is [lat, lng, intensity]
                    if (point.length === 3) {
                        return [point[0], point[1], point[2] * intensity];
                    }
                    return point;
                });

                // Create new heatmap with updated settings
                heatmapLayer = L.heatLayer(scaledPoints, {
                    radius: radius,
                    blur: blur,
                    maxZoom: 17,
                    gradient: gradient
                }).addTo(directMap);

                // Update the overlay control
                updateLayerControl();
            });

            // Reset button handler
            resetButton.addEventListener('click', function() {
                // Reset all values to defaults
                radiusSlider.value = 25;
                radiusValue.textContent = 25;

                intensitySlider.value = 0.6;
                intensityValue.textContent = 0.6;

                blurSlider.value = 15;
                blurValue.textContent = 15;

                colorSchemeSelect.value = 'default';

                setColorScheme('blue', 'cyan', 'lime', 'red', 0.2, 0.4, 0.6, 0.8);
                updateGradientPreview();

                // Apply default settings immediately
                applyButton.click();
            });
        }

        function updateLayerControl() {
            // Remove existing controls
            try {
                directMap.removeControl(directMap._layersControl);
            } catch (e) {
                console.log("No existing layer control to remove");
            }

            // Add base layers
            const baseLayers = {
                "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                })
            };

            // Add overlay layers
            const overlayLayers = {
                "Existing Hospitals": hospitalsLayer
            };

            if (heatmapLayer) {
                overlayLayers["Population Density"] = heatmapLayer;
            }

            // Create and add the control
            directMap._layersControl = L.control.layers(baseLayers, overlayLayers).addTo(directMap);
        }

        function setupDirectMapClickHandler() {
            // Handle click toggle
            const clickToggle = document.getElementById('enableDirectMapClick');

            clickToggle.addEventListener('change', function() {
                if (this.checked) {
                    // Enable click analysis
                    directMap.on('click', analyzeDirectMapLocation);
                    directMap.getContainer().style.cursor = 'crosshair';
                } else {
                    // Disable click analysis
                    directMap.off('click', analyzeDirectMapLocation);
                    directMap.getContainer().style.cursor = '';
                }
            });

            // Initially enable click analysis if checkbox is checked
            if (clickToggle.checked) {
                directMap.on('click', analyzeDirectMapLocation);
                directMap.getContainer().style.cursor = 'crosshair';
            }
        }

        function analyzeDirectMapLocation(e) {
            // Get click coordinates
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            const radius = parseFloat(document.getElementById('directAnalysisRadius').value);

            // Remove previous marker and circle
            if (selectedMarker) {
                directMap.removeLayer(selectedMarker);
            }
            if (analysisCircle) {
                directMap.removeLayer(analysisCircle);
            }

            // Add new marker and circle
            selectedMarker = L.marker([lat, lng]).addTo(directMap);
            analysisCircle = L.circle([lat, lng], {
                radius: radius * 1000, // Convert to meters
                color: '#4285F4',
                fillColor: '#4285F4',
                fillOpacity: 0.2
            }).addTo(directMap);

            // Show the analysis modal
            showAnalysisLoading();
            analysisModal.show();

            // Prepare the data for the API call
            const requestData = {
                latitude: lat,
                longitude: lng,
                radius: radius
            };

            // Call the backend API to analyze the location
            fetch('/analyze_location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show the results
                    showAnalysisResults(data);
                } else {
                    // Show error
                    showAnalysisError(data.error || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error analyzing location:', error);
                showAnalysisError('Failed to analyze location: ' + error.message);
            });
        }

        function showAnalysisLoading() {
            document.getElementById('analysisLoading').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';
            document.getElementById('analysisError').style.display = 'none';
        }

        function showAnalysisResults(data) {
            // Hide loading indicator
            document.getElementById('analysisLoading').style.display = 'none';
            document.getElementById('analysisError').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'block';

            // Update UI with results
            const stats = data.statistics;
            const recommendation = data.recommendation;
            const location = data.location;

            // Update statistics
            document.getElementById('locationCoordinates').textContent = `${location.latitude.toFixed(5)}, ${location.longitude.toFixed(5)}`;
            document.getElementById('analysisRadius').textContent = `${location.radius_km} km`;
            document.getElementById('populationCount').textContent = `${stats.population_within_radius.toLocaleString()}`;
            document.getElementById('hospitalCount').textContent = `${stats.hospitals_within_radius}`;

            // Update recommendation
            const percentage = recommendation.percentage;
            document.getElementById('recommendationPercentage').textContent = `${percentage}%`;
            document.getElementById('recommendationExplanation').textContent = recommendation.explanation;

            // Animate the gauge
            const dashArray = 376.8; // 2 * PI * 60 (circle radius)
            const dashOffset = dashArray * (1 - percentage / 100);
            const gauge = document.getElementById('recommendationGauge');

            // Set color based on percentage
            let color = '#4285F4'; // Default blue
            if (percentage >= 75) {
                color = '#34A853'; // Green
            } else if (percentage >= 50) {
                color = '#FBBC05'; // Yellow
            } else if (percentage < 30) {
                color = '#EA4335'; // Red
            }

            gauge.style.stroke = color;
            gauge.style.strokeDashoffset = dashArray;

            // Animate gauge
            setTimeout(() => {
                gauge.style.transition = 'stroke-dashoffset 1s ease-in-out';
                gauge.style.strokeDashoffset = dashOffset;
            }, 100);

            // Create location map with the analyzed area in the modal
            setTimeout(() => {
                createLocationMap(data);
            }, 300);
        }

        function showAnalysisError(errorMessage) {
            document.getElementById('analysisLoading').style.display = 'none';
            document.getElementById('analysisResults').style.display = 'none';

            const errorElement = document.getElementById('analysisError');
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';
        }

        function createLocationMap(data) {
            const mapContainer = document.getElementById('locationMapContainer');

            // Clear any existing map
            mapContainer.innerHTML = '';

            // Create new map
            locationMap = L.map(mapContainer).setView(
                [data.visualization.center.lat, data.visualization.center.lng],
                data.visualization.zoom
            );

            // Add base tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(locationMap);

            // Add circle for analysis radius
            const circleData = data.visualization.circle;
            L.circle(
                [circleData.center.lat, circleData.center.lng],
                {
                    radius: circleData.radius,
                    color: circleData.options.color,
                    fillColor: circleData.options.fillColor,
                    fillOpacity: circleData.options.fillOpacity
                }
            ).addTo(locationMap);

            // Add markers for hospitals and the center point
            data.visualization.markers.forEach(marker => {
                const icon = L.divIcon({
                    html: `<i class="fa fa-${marker.icon.icon}" style="color: ${marker.icon.markerColor === 'red' ? '#EA4335' : '#4285F4'}; font-size: 18px;"></i>`,
                    className: 'custom-div-icon',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                L.marker([marker.lat, marker.lng], { icon: icon })
                    .bindPopup(marker.popup)
                    .addTo(locationMap);
            });

            // Invalidate map size to ensure proper rendering
            setTimeout(() => {
                locationMap.invalidateSize();
            }, 100);
        }
    </script>
</body>
</html>
